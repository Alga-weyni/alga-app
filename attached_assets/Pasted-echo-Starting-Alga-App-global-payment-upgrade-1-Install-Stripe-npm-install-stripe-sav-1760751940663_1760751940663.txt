echo "ğŸš€ Starting Alga App global payment upgrade..."

# 1ï¸âƒ£ Install Stripe
npm install stripe --save

# 2ï¸âƒ£ Add all environment variables (update with real keys later)
replit secrets add STRIPE_SECRET_KEY="sk_live_your_real_key_here"
replit secrets add STRIPE_PUBLIC_KEY="pk_live_your_real_key_here"
replit secrets add STRIPE_WEBHOOK_SECRET="whsec_your_real_key_here"
replit secrets add SUPPORTED_CURRENCIES="ETB,USD,CNY"
replit secrets add BASE_URL="https://ce3a76da-b414-4186-9234-d3db2b65b94b-00-2df3xcgh8cs7v.kirk.replit.dev"

# 3ï¸âƒ£ Create/Update backend payment route
cat > server/payment_stripe.ts <<'EOF'
import express from "express";
import Stripe from "stripe";
const router = express.Router();

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: "2024-06-20",
});

router.post("/stripe", async (req, res) => {
  try {
    const { amount, currency = "CNY", description, bookingId } = req.body;
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100),
      currency,
      description,
      automatic_payment_methods: { enabled: true },
      metadata: { bookingId },
    });
    res.json({ success: true, clientSecret: paymentIntent.client_secret });
  } catch (error) {
    console.error("Stripe Payment Error:", error);
    res.status(500).json({ success: false, message: "Stripe payment failed" });
  }
});

router.post(
  "/stripe/webhook",
  express.raw({ type: "application/json" }),
  (req, res) => {
    const sig = req.headers["stripe-signature"];
    let event;
    try {
      event = stripe.webhooks.constructEvent(
        req.body,
        sig!,
        process.env.STRIPE_WEBHOOK_SECRET!
      );
    } catch (err) {
      console.log("Webhook Error:", err);
      return res.sendStatus(400);
    }

    if (event.type === "payment_intent.succeeded") {
      const paymentIntent = event.data.object as any;
      console.log("âœ… Payment successful for booking:", paymentIntent.metadata.bookingId);
      // TODO: Update booking status to 'paid' in DB here
    }

    res.sendStatus(200);
  }
);

export default router;
EOF

# 4ï¸âƒ£ Integrate new route into main backend
sed -i '/import.*payment/i import paymentStripeRoutes from "./payment_stripe";' server/routes.ts
sed -i '/app.use.*payment/i app.use("/api/payment", paymentStripeRoutes);' server/routes.ts

# 5ï¸âƒ£ Rebuild and restart server
echo "âš™ï¸ Restarting Alga backend..."
npm run build || echo "No build script found, skipping..."
npm start & sleep 10

# 6ï¸âƒ£ Quick health check
echo "ğŸ” Checking routes..."
curl -I https://ce3a76da-b414-4186-9234-d3db2b65b94b-00-2df3xcgh8cs7v.kirk.replit.dev/api/payment/stripe || true

echo "âœ… Done! Stripe + CNY + Credit Card payment integration added successfully."
echo "ğŸ‘‰ Next: Go to Stripe Dashboard to get your real keys and replace them in Replit Secrets."