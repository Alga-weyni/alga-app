echo "ğŸš€ Starting automatic payment test for Alga App..."

# 1ï¸âƒ£ Verify required environment variables
if [ -z "$BASE_URL" ]; then
  echo "âš ï¸ BASE_URL not found. Please set it before running this test."
  exit 1
fi
if [ -z "$STRIPE_SECRET_KEY" ]; then
  echo "âš ï¸ STRIPE_SECRET_KEY not found. Please set it in Replit Secrets."
  exit 1
fi

# 2ï¸âƒ£ Test local Telebirr (ETB) payment route
echo "ğŸ§ª Testing Telebirr ETB payment endpoint..."
curl -X POST "$BASE_URL/api/payment/telebirr" \
     -H "Content-Type: application/json" \
     -d '{"amount":1,"currency":"ETB","description":"Test ETB Booking","bookingId":"test-etb-001"}' \
     -s -o /tmp/telebirr_test.log -w "%{http_code}\n"

if grep -q "success" /tmp/telebirr_test.log; then
  echo "âœ… Telebirr ETB payment simulation successful!"
else
  echo "âŒ Telebirr ETB route failed or not configured. Check /api/payment/telebirr logs."
fi

# 3ï¸âƒ£ Test Stripe (CNY / Credit Card) payment route
echo "ğŸ§ª Testing Stripe CNY payment endpoint..."
curl -X POST "$BASE_URL/api/payment/stripe" \
     -H "Content-Type: application/json" \
     -d '{"amount":1,"currency":"CNY","description":"Test CNY Booking","bookingId":"test-cny-001"}' \
     -s -o /tmp/stripe_test.log -w "%{http_code}\n"

if grep -q "success" /tmp/stripe_test.log; then
  echo "âœ… Stripe CNY (AliPay/WeChat/Credit Card) simulation successful!"
else
  echo "âŒ Stripe CNY route failed or returned error. Check /api/payment/stripe logs."
fi

# 4ï¸âƒ£ Test backend stability
echo "ğŸ” Checking API health..."
curl -I "$BASE_URL/api/payment/stripe" -s | head -n 1

# 5ï¸âƒ£ Summary
echo "--------------------------------------"
echo "ğŸ“Š PAYMENT SANDBOX TEST SUMMARY"
if grep -q "success" /tmp/telebirr_test.log && grep -q "success" /tmp/stripe_test.log; then
  echo "ğŸ‰ All payment integrations (ETB + CNY) operational!"
  echo "ğŸ’³ Youâ€™re ready for full go-live deployment."
else
  echo "âš ï¸ One or more tests failed â€” check your Replit console logs for details."
fi
echo "--------------------------------------"