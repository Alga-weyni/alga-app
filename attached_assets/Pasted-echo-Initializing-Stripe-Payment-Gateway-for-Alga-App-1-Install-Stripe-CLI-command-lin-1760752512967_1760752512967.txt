echo "ğŸš€ Initializing Stripe Payment Gateway for Alga App..."

# 1ï¸âƒ£ Install Stripe CLI (command-line interface)
npm install -g stripe || echo "Stripe CLI already installed"

# 2ï¸âƒ£ Authenticate your Stripe CLI (youâ€™ll paste your API key once)
echo "ğŸ” Logging into Stripe CLI..."
stripe login

# 3ï¸âƒ£ Register your webhook directly from Replit
echo "ğŸ“¡ Registering webhook endpoint..."
stripe webhook create \
  --url "https://ce3a76da-b414-4186-9234-d3db2b65b94b-00-2df3xcgh8cs7v.kirk.replit.dev/api/payment/webhook/stripe" \
  --events "payment_intent.succeeded" "payment_intent.payment_failed" \
  --test-mode > stripe_webhook_output.json

# 4ï¸âƒ£ Extract Webhook Secret automatically
export STRIPE_WEBHOOK_SECRET=$(cat stripe_webhook_output.json | grep -o '"secret": *"[^"]*"' | cut -d'"' -f4)
echo "âœ… Webhook secret captured: $STRIPE_WEBHOOK_SECRET"

# 5ï¸âƒ£ Add secrets directly to Replit environment
echo "âš™ï¸ Adding Stripe environment variables..."
replit secrets add STRIPE_SECRET_KEY="sk_test_your_real_key_here"
replit secrets add VITE_STRIPE_PUBLIC_KEY="pk_test_your_real_key_here"
replit secrets add STRIPE_WEBHOOK_SECRET="$STRIPE_WEBHOOK_SECRET"

# 6ï¸âƒ£ Verify secrets are added
echo "ğŸ” Verifying saved secrets..."
replit secrets list | grep STRIPE

# 7ï¸âƒ£ Rebuild and restart the server
echo "ğŸ” Restarting your Alga backend..."
npm run build || echo "No build script found, skipping..."
npm start & sleep 10

# 8ï¸âƒ£ Test Stripe payment endpoint (CNY test)
echo "ğŸ’³ Testing Stripe (CNY) route..."
curl -X POST "https://ce3a76da-b414-4186-9234-d3db2b65b94b-00-2df3xcgh8cs7v.kirk.replit.dev/api/payment/stripe" \
     -H "Content-Type: application/json" \
     -d '{"amount":1,"currency":"CNY","description":"Test CNY Booking","bookingId":"stripe-cny-001"}'

# 9ï¸âƒ£ Summary
echo "--------------------------------------"
echo "âœ… STRIPE SETUP SUMMARY"
echo "Base URL: https://ce3a76da-b414-4186-9234-d3db2b65b94b-00-2df3xcgh8cs7v.kirk.replit.dev"
echo "Webhook: /api/payment/webhook/stripe"
echo "Currencies: ETB, USD, CNY"
echo "Gateways: Telebirr ğŸ‡ªğŸ‡¹ | Stripe (AliPay/WeChat/Credit Cards) ğŸŒ"
echo "--------------------------------------"
echo "ğŸ‰ Alga App is now Stripe-ready via command-line automation!"