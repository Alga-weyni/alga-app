import { useEffect, useRef, useState } from "react";
import QrScanner from "qr-scanner"; // npm install qr-scanner

export default function EthiopianIDScanner() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const [message, setMessage] = useState("Tap below to scan your Ethiopian ID");

  const startScan = async () => {
    try {
      setMessage("Accessing camera...");
      const devices = await navigator.mediaDevices.enumerateDevices();
      const backCamera = devices.find(
        (d) => d.kind === "videoinput" && d.label.toLowerCase().includes("back")
      );

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: backCamera?.deviceId || undefined },
      });

      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.play();

        const scanner = new QrScanner(
          videoRef.current,
          async (result) => {
            setMessage("Verifying ID...");
            const response = await fetch("/api/verify-id", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ qr: result.data }),
            });
            const data = await response.json();

            if (data.success) {
              setMessage("✅ ID verified successfully!");
            } else {
              setMessage("❌ Verification failed. Try again.");
            }

            scanner.stop();
            stream.getTracks().forEach((t) => t.stop());
          },
          { returnDetailedScanResult: true }
        );
        scanner.start();
        setMessage("Hold your ID steady within the frame");
      }
    } catch (err) {
      console.error(err);
      setMessage("Camera access denied or not found");
    }
  };

  return (
    <div
      style={{
        textAlign: "center",
        marginTop: "2rem",
        fontFamily: "Inter, sans-serif",
      }}
    >
      <h2>Scan Your Ethiopian ID</h2>
      <video ref={videoRef} style={{ width: "90%", borderRadius: "12px" }} />
      <p style={{ marginTop: "1rem", color: "#555" }}>{message}</p>
      <button
        onClick={startScan}
        style={{
          background: "#F97316",
          border: "none",
          borderRadius: "8px",
          color: "#fff",
          fontSize: "16px",
          padding: "10px 20px",
          marginTop: "1rem",
        }}
      >
        Start Scan
      </button>
      <p style={{ fontSize: "12px", color: "#777", marginTop: "1rem" }}>
        Supports Ethiopian Digital ID QR codes • OCR Ready • Secure Verification
      </p>
    </div>
  );
}