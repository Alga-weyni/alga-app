You want two login options:

Phone number + password (with OTP verification for phone signup/login)

Email + password (standard credential login)

Both should work under one unified authentication system ‚Äî using your existing PostgreSQL + Drizzle ORM + bcrypt setup.

üß© 1. Database Schema Update (Users Table)

Your current users table likely has email, password, and role.
We‚Äôll extend it slightly to handle phone-based auth and OTP codes.

// drizzle schema (example)
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  email: text("email").unique(),
  phone: text("phone").unique(),
  password: text("password"), // hashed with bcrypt
  role: text("role").notNull().default("tenant"),
  isVerified: boolean("is_verified").default(false),
  otpCode: text("otp_code"),
  otpExpiresAt: timestamp("otp_expires_at")
});


This enables either email or phone login, while storing OTP for temporary validation.

üì± 2. Unified Login Form (Frontend)

You‚Äôll create one login form but with a toggle or tabs:

<LoginForm>
  <Tabs>
    <Tab label="Phone Login">
      <Input placeholder="Phone number" name="phone" />
      <Input placeholder="Password" type="password" name="password" />
    </Tab>
    <Tab label="Email Login">
      <Input placeholder="Email address" name="email" />
      <Input placeholder="Password" type="password" name="password" />
    </Tab>
  </Tabs>
  <Button type="submit">Login</Button>
</LoginForm>


Each tab triggers a different backend route, but both feed into the same authentication controller.

‚öôÔ∏è 3. Backend Logic (Express or Next.js API Routes)

Here‚Äôs the logic for both options simplified:

Option A: Login with Email + Password
const user = await db.select().from(users).where(eq(users.email, req.body.email));
if (!user || !(await bcrypt.compare(req.body.password, user.password))) {
  throw new Error("Invalid credentials");
}
session.create(user.id);
redirectByRole(user.role);

Option B: Login with Phone + Password + OTP

User enters phone + password

System checks credentials

If valid ‚Üí system sends OTP via Ethio Telecom API

User enters OTP ‚Üí verified ‚Üí login session created

Example flow:

const user = await db.select().from(users).where(eq(users.phone, req.body.phone));
if (!user || !(await bcrypt.compare(req.body.password, user.password))) {
  throw new Error("Invalid credentials");
}

// generate OTP
const otp = Math.floor(100000 + Math.random() * 900000).toString();
await db.update(users)
  .set({ otpCode: otp, otpExpiresAt: new Date(Date.now() + 5 * 60 * 1000) })
  .where(eq(users.phone, req.body.phone));

// send OTP via Ethio Telecom API (placeholder)
await sendSMS(user.phone, `Your Alga verification code is ${otp}`);


Then you create a second route /api/verify-otp:

const user = await db.select().from(users)
  .where(eq(users.phone, req.body.phone))
  .where(eq(users.otpCode, req.body.otp));

if (user && user.otpExpiresAt > new Date()) {
  await db.update(users).set({ isVerified: true, otpCode: null }).where(eq(users.id, user.id));
  session.create(user.id);
  redirectByRole(user.role);
} else {
  throw new Error("Invalid or expired OTP");
}

üí¨ 4. OTP Sending Integration (Ethiopia Context)

You‚Äôll connect to Ethio Telecom SMS API or a local aggregator like:

Africastalking Ethiopia

Addis SMS Gateway

Telebirr Developer API (for combined payments + messaging)

These services will provide:

API key

Endpoint: POST https://api.africastalking.com/version1/messaging

Payload:

{
  "username": "yourAppName",
  "to": "+251912XXXXXX",
  "message": "Your OTP code is 123456"
}

üîÅ 5. Signup Flow (With OTP)

When signing up using a phone number:

User enters phone + password

OTP sent to verify phone

Once verified, account is marked as isVerified = true

Email signups skip OTP unless you want optional verification later.

üß† 6. Recommended UI Flow
Step	Screen	Description
1	/login	Toggle between Email / Phone login
2	/verify-otp	Only appears for phone login
3	/register	User chooses ‚ÄúSign up with Email‚Äù or ‚ÄúSign up with Phone‚Äù
4	/dashboard	Redirects based on user role (Admin, Operator, Owner, Tenant)
‚úÖ Security Notes

Use bcrypt for all password storage.

Expire OTP codes within 5 minutes.

Limit attempts (3‚Äì5 per hour per phone).

Always clear OTP fields after successful verification.