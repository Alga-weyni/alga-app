# ==================================================
# 1Ô∏è‚É£  VERIFY & FIX DATABASE SCHEMA
# ==================================================
echo "üîç Checking Lemlem-related database tables..."
psql $DATABASE_URL -c "\dt" | grep -E "lemlem|property_info|platform_settings|lemlem_chats" || \
echo "‚ö†Ô∏è Missing tables detected ‚Äî running Drizzle push..."
npx drizzle-kit push --config=drizzle.config.ts

# ==================================================
# 2Ô∏è‚É£  TEST KEY API ENDPOINTS
# ==================================================
echo "üß† Testing Lemlem message API..."
curl -s -X POST http://localhost:5000/api/lemlem/message \
  -H "Content-Type: application/json" \
  -d '{"text":"Hello","lang":"en-US"}' && echo ""
curl -s -X POST http://localhost:5000/api/lemlem/message \
  -H "Content-Type: application/json" \
  -d '{"text":"‰Ω†Â•Ω","lang":"zh-CN"}' && echo ""

# ==================================================
# 3Ô∏è‚É£  FIX VOICE RATE (FASTER GRANDMOTHER)
# ==================================================
echo "üéôÔ∏è Updating Lemlem‚Äôs voice to slightly faster rate..."
cat > client/src/utils/lemlemVoice.ts <<'EOF'
export function getGrandmotherVoice(text, lang) {
  try {
    const synth = window.speechSynthesis;
    if (!synth) return console.warn("Speech synthesis not supported.");

    const voices = synth.getVoices();
    const femaleVoice =
      voices.find(v => v.lang.startsWith(lang) && /female|woman|grandmother/i.test(v.name)) ||
      voices.find(v => v.lang.startsWith(lang)) ||
      voices.find(v => v.lang.startsWith('en')) ||
      voices[0];

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = lang;
    utter.voice = femaleVoice;
    utter.rate = 0.85;   // slightly faster, still warm and patient
    utter.pitch = 1.1;   // soft, calm tone
    utter.volume = 1.0;
    setTimeout(() => synth.speak(utter), 250); // gentle pause
  } catch (e) {
    console.warn("Voice error:", e);
  }
}
EOF

# ==================================================
# 4Ô∏è‚É£  REBUILD & RESTART APPLICATION
# ==================================================
echo "üß± Building and restarting Alga platform..."
npm run lint || true
npm run build
npm start &

# ==================================================
# 5Ô∏è‚É£  LOG & INSIGHT VALIDATION
# ==================================================
echo "üìä Checking Admin Lemlem Insights route..."
curl -s http://localhost:5000/api/lemlem/insights || echo "‚ö†Ô∏è Insights route may need refresh."
echo "‚úÖ Lemlem backend health verified, schema synced, and voice tuned to rate 0.85."
echo "üåç Lemlem is now warm, calm, and a little quicker ‚Äî like a thoughtful grandmother with energy!"