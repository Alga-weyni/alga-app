/**
 * ALGA REVIEW & RATING ENGINE â€“ ONE-STEP SETUP
 * Features:
 *  â­ Weighted 1â€“5 rating per property/host
 *  ðŸ”„ Auto-recalculate overall score after each review
 *  ðŸ… Rank sorting by rating + recency
 */

import { db } from "@/shared/db";
import { reviews, properties } from "@/shared/schema";
import { eq, desc } from "drizzle-orm";
import { NextRequest, NextResponse } from "next/server";

/* ---------- ADD REVIEW (POST) ---------- */
export async function POST(req: NextRequest) {
  try {
    const data = await req.json();
    const { bookingId, propertyId, hostId, guestId, rating, cleanliness, communication, accuracy, location, value, comment } = data;

    if (!propertyId || !rating) {
      return NextResponse.json({ error: "Property ID and rating required" }, { status: 400 });
    }

    // Insert new review
    await db.insert(reviews).values({
      bookingId,
      propertyId,
      hostId,
      guestId,
      rating,
      cleanliness,
      communication,
      accuracy,
      location,
      value,
      comment,
    });

    // Recalculate rating immediately
    const newRating = await recalcPropertyRating(propertyId);
    await db.update(properties).set({ rating: newRating }).where(eq(properties.id, propertyId));

    return NextResponse.json({ success: true, rating: newRating });
  } catch (err: any) {
    console.error("âŒ Review submission failed:", err);
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}

/* ---------- FETCH REVIEWS (GET) ---------- */
export async function GET(req: NextRequest) {
  try {
    const url = new URL(req.url);
    const propertyId = Number(url.searchParams.get("propertyId"));
    if (!propertyId) return NextResponse.json({ error: "propertyId required" }, { status: 400 });

    const allReviews = await db.select().from(reviews).where(eq(reviews.propertyId, propertyId)).orderBy(desc(reviews.createdAt));
    return NextResponse.json(allReviews);
  } catch (err: any) {
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}

/* ---------- WEIGHTED RATING CALCULATOR ---------- */
async function recalcPropertyRating(propertyId: number) {
  const list = await db.select().from(reviews).where(eq(reviews.propertyId, propertyId));
  if (!list.length) return 0;

  const now = new Date();
  let weightedSum = 0;
  let totalWeight = 0;

  list.forEach((r: any) => {
    const ageDays = (now.getTime() - new Date(r.createdAt).getTime()) / (1000 * 60 * 60 * 24);
    const weight = 1 / (1 + ageDays / 90); // 3-month decay curve
    weightedSum += r.rating * weight;
    totalWeight += weight;
  });

  return Number((weightedSum / totalWeight).toFixed(2));
}

/* ---------- TOP-RATED PROPERTIES (OPTIONAL) ---------- */
export async function getTopRated(limit = 10) {
  return await db.select().from(properties).orderBy(desc(properties.rating)).limit(limit);
}