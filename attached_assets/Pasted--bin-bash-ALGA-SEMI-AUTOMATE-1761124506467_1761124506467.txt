#!/bin/bash
# ==============================================================
# üü§ ALGA SEMI-AUTOMATED DEPLOYMENT SCRIPT
# Author: Weyni Abraha | Version 1.0 | 2025
# Purpose: Prepare Alga App for secure production deployment
# ===============================================================

echo "üöÄ Starting Alga Semi-Automated Deployment..."
echo "=============================================================="

# -------------------------------
# 1Ô∏è‚É£ Verify Environment Variables
# -------------------------------
if [ -z "$DATABASE_URL" ]; then
  echo "‚ùå ERROR: DATABASE_URL not set."
  echo "Go to Replit ‚ûú Tools ‚ûú Secrets ‚ûú Add DATABASE_URL first."
  exit 1
fi

# -------------------------------
# 2Ô∏è‚É£ Generate Secure SESSION_SECRET (if missing)
# -------------------------------
if [ -z "$SESSION_SECRET" ]; then
  echo "üîê Generating SESSION_SECRET..."
  export SESSION_SECRET=$(openssl rand -hex 32)
  echo "SESSION_SECRET generated (not printed for security)."
fi

# -------------------------------
# 3Ô∏è‚É£ Install Dependencies
# -------------------------------
echo "üì¶ Installing dependencies..."
npm install

# -------------------------------
# 4Ô∏è‚É£ Build Production Version
# -------------------------------
echo "üß± Building production version..."
npm run build || { echo "‚ùå Build failed."; exit 1; }

# -------------------------------
# 5Ô∏è‚É£ Initialize Database
# -------------------------------
echo "üóÑÔ∏è Running database migrations..."
npx drizzle-kit push --config=drizzle.config.ts || { echo "‚ùå Database push failed."; exit 1; }

# -------------------------------
# 6Ô∏è‚É£ Seed Data
# -------------------------------
echo "üå± Seeding database..."
npm run seed || echo "‚ö†Ô∏è Seed script not found or already seeded."

# -------------------------------
# 7Ô∏è‚É£ Git Commit & Push
# -------------------------------
echo "üì§ Preparing GitHub push..."
git add .
git commit -m "Automated deployment preparation" || echo "‚ÑπÔ∏è No changes to commit."
git branch -M main
git push origin main || { echo "‚ùå Git push failed."; exit 1; }

# -------------------------------
# 8Ô∏è‚É£ Display Next Deployment Steps
# -------------------------------
echo "=============================================================="
echo "‚úÖ LOCAL TASKS COMPLETED SUCCESSFULLY!"
echo ""
echo "üåê NEXT STEPS (Manual Web-Based Deployment)"
echo "----------------------------------------------"
echo "1Ô∏è‚É£ Go to https://render.com ‚ûú Create Web Service"
echo "   ‚Ä¢ Select your GitHub repo (alga-app)"
echo "   ‚Ä¢ Environment Variables:"
echo "       DATABASE_URL = (your Neon DB URL)"
echo "       SENDGRID_API_KEY = (for OTP emails)"
echo "       SESSION_SECRET = (use the generated one)"
echo "       NODE_ENV = production"
echo "       PORT = 10000"
echo "   ‚Ä¢ Start Command: npm start"
echo ""
echo "2Ô∏è‚É£ Go to https://vercel.com ‚ûú Import GitHub Project"
echo "   ‚Ä¢ Environment Variables:"
echo "       VITE_API_BASE_URL = https://<your-render-service>.onrender.com"
echo "       NODE_ENV = production"
echo "   ‚Ä¢ Deploy frontend"
echo ""
echo "3Ô∏è‚É£ After both deployments finish:"
echo "   ‚úÖ Test OTP login (SendGrid)"
echo "   ‚úÖ Test property add + booking flow"
echo "   ‚úÖ Test admin verification counts"
echo ""
echo "4Ô∏è‚É£ Once confirmed stable, cancel Replit Core Plan to cut costs."
echo "----------------------------------------------"
echo "üéâ Deployment Preparation Complete! üéâ"
echo "Backend: Render   |  Frontend: Vercel   |  Database: Neon"
echo "=============================================================="